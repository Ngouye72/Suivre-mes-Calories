input {
  beats {
    port => 5044
  }
  tcp {
    port => 5000
    codec => json
  }
  udp {
    port => 5000
    codec => json
  }
}

filter {
  if [type] == "nutrition-app" {
    grok {
      patterns_dir => ["/usr/share/logstash/patterns"]
      match => { "message" => "%{NUTRITION_LOG}" }
    }
    
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
      target => "@timestamp"
    }
    
    if [log_level] == "ERROR" {
      mutate {
        add_tag => ["error"]
      }
    }
    
    # Enrichissement des logs de repas
    if [event_type] == "meal_creation" {
      mutate {
        add_field => {
          "meal_category" => "%{[meal][category]}"
          "total_calories" => "%{[meal][calories]}"
        }
      }
    }
    
    # Enrichissement des logs d'objectifs
    if [event_type] == "goal_update" {
      mutate {
        add_field => {
          "goal_type" => "%{[goal][type]}"
          "target_value" => "%{[goal][target]}"
        }
      }
    }
    
    # Enrichissement des logs de prédictions ML
    if [event_type] == "ml_prediction" {
      mutate {
        add_field => {
          "prediction_type" => "%{[prediction][type]}"
          "confidence_score" => "%{[prediction][confidence]}"
        }
      }
    }
    
    # Géolocalisation pour les accès API
    if [event_type] == "api_request" {
      geoip {
        source => "client_ip"
        target => "geoip"
      }
    }
    
    # Ajout de métadonnées utilisateur
    if [user_id] {
      mutate {
        add_field => {
          "user_type" => "%{[user][type]}"
          "subscription_plan" => "%{[user][plan]}"
        }
      }
    }
  }
}

output {
  if [type] == "nutrition-app" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "nutrition-logs-%{+YYYY.MM.dd}"
      
      # Index spécifiques par type d'événement
      if [event_type] == "meal_creation" {
        index => "nutrition-meals-%{+YYYY.MM}"
      }
      if [event_type] == "goal_update" {
        index => "nutrition-goals-%{+YYYY.MM}"
      }
      if [event_type] == "ml_prediction" {
        index => "nutrition-ml-%{+YYYY.MM}"
      }
      if [event_type] == "api_request" {
        index => "nutrition-api-%{+YYYY.MM.dd}"
      }
      if "error" in [tags] {
        index => "nutrition-errors-%{+YYYY.MM.dd}"
      }
    }
  }
  
  # Logs système
  if [type] == "system" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "system-logs-%{+YYYY.MM.dd}"
    }
  }
  
  # Métriques de performance
  if [type] == "metrics" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "nutrition-metrics-%{+YYYY.MM.dd}"
    }
  }
}
